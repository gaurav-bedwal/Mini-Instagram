<!DOCTYPE html>
<html>
<head>
  <title>Feed</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/socket.io/socket.io.js"></script>

  <script>
  tailwind.config = {
    theme: {
      extend: {
        colors:{
          soft:"#f8fafc"
        }
      }
    }
  }
  </script>

  <style>
    /* animated background */
    body{
      background: linear-gradient(-45deg,#e0f2fe,#fce7f3,#f0fdf4,#ede9fe);
      background-size:400% 400%;
      animation:gradientMove 18s ease infinite;
      font-family:Inter,system-ui;
    }
    @keyframes gradientMove{
      0%{background-position:0% 50%}
      50%{background-position:100% 50%}
      100%{background-position:0% 50%}
    }

    /* glass card */
    .post-card{
      backdrop-filter:blur(12px);
      background:rgba(255,255,255,.65);
      transition:all .25s ease;
      box-shadow:0 10px 25px rgba(0,0,0,.08);
    }
    .post-card:hover{
      transform:translateY(-4px) scale(1.01);
      box-shadow:0 18px 45px rgba(0,0,0,.12);
    }

    /* like animation */
    .heart-pop{animation:heart .35s ease}
    @keyframes heart{
      0%{transform:scale(.6)}
      60%{transform:scale(1.4)}
      100%{transform:scale(1)}
    }

    /* comment slide */
    .comment-box{animation:slide .25s ease}
    @keyframes slide{
      from{opacity:0;transform:translateY(-8px)}
      to{opacity:1;transform:translateY(0)}
    }

    /* glow button */
    .glow:hover{
      box-shadow:0 0 12px rgba(59,130,246,.4);
    }
  </style>
</head>

<body>

<%- include("partials/nav") %>

<div class="max-w-xl mx-auto py-10 space-y-8">

<% posts.forEach(p=>{ %>

<div class="post-card rounded-3xl overflow-hidden">

  <!-- HEADER -->
  <div class="flex justify-between items-center px-5 pt-4">
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-400 to-purple-400"></div>
      <div class="font-semibold text-gray-800"><%= p.user.username %></div>
    </div>

    <% if(p.user._id.toString() === session.userId){ %>
    <div class="flex gap-2 text-xs">
      <a href="/edit/<%= p._id %>" class="px-3 py-1 bg-white/60 rounded-full">Edit</a>
      <form action="/delete/<%= p._id %>?_method=DELETE" method="POST">
        <button class="px-3 py-1 bg-red-100 text-red-600 rounded-full">Delete</button>
      </form>
    </div>
    <% } %>
  </div>

  <!-- IMAGE -->
  <img src="<%= p.image %>" class="w-full mt-3">

  <!-- CAPTION -->
  <div class="px-5 py-3 text-gray-800">
    <span class="font-semibold"><%= p.user.username %></span>
    <%= p.caption %>
  </div>

  <!-- ACTIONS -->
  <div class="flex gap-6 px-5 pb-3 text-lg items-center">

    <button onclick="toggleLike('<%= p._id %>', this)" class="flex items-center gap-2 glow px-3 py-2 rounded-full">
      <span class="likeIcon text-2xl"><%= p.likes.includes(session.userId) ? "â¤ï¸" : "ðŸ¤" %></span>
      <span class="likeCount text-sm font-semibold"><%= p.likes.length %></span>
    </button>

    <button onclick="toggleCommentBox('<%= p._id %>')" class="hover:scale-110 transition">ðŸ’¬</button>
    <button onclick="sharePost('<%= p._id %>', this)" class="hover:scale-110 transition">ðŸ”—</button>

  </div>

  <!-- COMMENTS -->
  <div id="comments-<%= p._id %>" class="hidden px-5 pb-4 comment-box">

    <div id="commentList-<%= p._id %>" class="space-y-1 mb-2">
      <% (p.comments||[]).forEach(c=>{ %>
        <div class="text-sm bg-white/50 px-3 py-1 rounded-xl">
          <b><%= c.user.username %></b> <%= c.text %>
        </div>
      <% }) %>
    </div>

    <div class="flex gap-2">
      <input id="input-<%= p._id %>" class="flex-1 rounded-full px-3 py-1 bg-white/70" placeholder="write something nice...">
      <button onclick="addComment('<%= p._id %>')" class="bg-blue-500 text-white px-3 rounded-full">Post</button>
    </div>

  </div>

</div>

<% }) %>

</div>


<script>
const socket=io();

/* realtime comment */
socket.on("new-comment",(data)=>{
  const list=document.getElementById("commentList-"+data.postId);
  if(!list) return;
  list.insertAdjacentHTML("beforeend",
    `<div class="text-sm bg-white/50 px-3 py-1 rounded-xl"><b>${data.username}</b> ${data.text}</div>`
  );
});

/* like */
async function toggleLike(postId,btn){
  const res=await fetch(`/like/${postId}`,{method:"POST",credentials:"same-origin"});
  const data=await res.json();

  const icon=btn.querySelector(".likeIcon");
  const count=btn.querySelector(".likeCount");

  icon.textContent=data.liked?"â¤ï¸":"ðŸ¤";
  icon.classList.add("heart-pop");
  setTimeout(()=>icon.classList.remove("heart-pop"),300);

  count.textContent=data.count;
}

/* comment */
function toggleCommentBox(id){
  document.getElementById("comments-"+id).classList.toggle("hidden");
}

async function addComment(id){
  const input=document.getElementById("input-"+id);
  if(!input.value.trim()) return;

  await fetch("/comment/"+id,{
    method:"POST",
    credentials:"same-origin",
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({text:input.value})
  });

  input.value="";
}

/* share */
function sharePost(id,btn){
  navigator.clipboard.writeText(window.location.origin+"/post/"+id);
  btn.textContent="âœ“";
  setTimeout(()=>btn.textContent="ðŸ”—",1000);
}
</script>

</body>
</html>